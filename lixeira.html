<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIXEIRA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.2.6/mqtt.js"></script>

</head>

<body>
    <h1> LIXEIRA </h1>
    <div id="div_pub"></div>

    <script>
        const client = mqtt.connect("ws://test.mosquitto.org:8081/mqtt");
        var div = document.querySelector("#div_pub");

        var id = Math.floor(1000 * Math.random() + 2);
        var latitude = Math.floor(90 * Math.random() + 1);
        var longitude = Math.floor(90 * Math.random() + 1);
        var json1 = {
            id: id,
            Região: "X",
            Capacidade: 0.0,
            Longitude: longitude,
            Latitude: latitude
        };

        client.on("connect", function () {
            console.log("Conectado ao MQTT");
            div.innerHTML = "PUB: Conectado ao MQTT";
            //public em um tópico

            setInterval(() => {
                var cap = "" + Math.floor(5 * Math.random() + 1) + "%";
                //evitar que ultrapasse a 100%
                if (parseFloat(json1.Capacidade) < 100
                    && parseFloat(json1.Capacidade) + parseFloat(cap) <= 100) {
                    json1.Capacidade = parseFloat(json1.Capacidade) + parseFloat(cap);
                } else if (!(parseFloat(json1.Capacidade) + parseFloat(cap) <= 100)) {
                    json1.Capacidade=100.0
                    //se já estiver proxima de 100% completa a lixeira
                }

                client.publish("GCS/lixeira", JSON.stringify(json1));
                console.log("mensagem enviada: " + JSON.stringify(json1))
            }, 5000)

        });

        console.log("A conectar...");
        div.innerHTML = "A conectar...";             
    </script>
</body>

</html>